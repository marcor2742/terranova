<div class="box">
	<h2>Login Page</h2>

	<form [formGroup]="loginForm" (ngSubmit)="UpdateData()">
		<!-- Username field with user existence check -->
		<div class="form-field">
			<label for="username">Username:</label>
			<input
				id="username"
				type="text"
				formControlName="username"
				(blur)="checkIfUserExist()"
			/>
			<div
				*ngIf="
					loginForm.get('username')?.touched &&
					loginForm.get('username')?.errors
				"
				class="error"
			>
				<div *ngIf="loginForm.get('username')?.errors?.['required']">
					Username is required
				</div>
				<div *ngIf="loginForm.get('username')?.errors?.['minlength']">
					Username must be at least 4 characters
				</div>
			</div>

			<!-- User existence feedback -->
			<div
				*ngIf="
					usernameChecked &&
					usernameChecked === loginForm.get('username')?.value
				"
				class="user-status"
			>
				<div *ngIf="usernameExist" class="exists">
					User exists. Please enter password to login.
				</div>
				<div *ngIf="!usernameExist" class="not-exists">
					Username not found. Please complete registration.
				</div>
			</div>
		</div>

		<div class="form-field" *ngIf="registerDiv()">
			<label for="email">Full Email:</label>
			<input
				id="email"
				type="email"
				formControlName="email"
				(blur)="checkEmailExists()"
			/>
			<div
				*ngIf="
					loginForm.get('email')?.touched &&
					loginForm.get('email')?.errors
				"
				class="error"
			>
				<div *ngIf="loginForm.get('email')?.errors">
					Please enter a valid email
				</div>
			</div>
			<!-- Email existence feedback -->
			<div *ngIf="emailError" class="error email-exists">
				{{ emailError }}
			</div>
		</div>

		<!-- Password field -->

		<div class="form-field">
			<label for="password">Password:</label>
			<input id="password" type="password" formControlName="password" />
			<div
				*ngIf="
					loginForm.get('password')?.touched &&
					loginForm.get('password')?.errors
				"
				class="error"
			>
				<div *ngIf="loginForm.get('password')?.errors?.['required']">
					Password is required
				</div>
			</div>
		</div>

		<button
			type="submit"
			[disabled]="!loginForm.valid"
			[ngClass]="{ disabled: !loginForm.valid }"
		>
			LOGIN
		</button>
		<p></p>
		<button
			type="submit"
			[disabled]="!loginForm.valid"
			[ngClass]="{ disabled: !loginForm.valid }"
		>
			REGISTER
		</button>
	</form>

	<p>Form Status: {{ loginForm.status }}</p>
	<!-- Email Confirmation Modal -->
	<div class="modal-overlay" *ngIf="showEmailConfirmation">
		<div class="modal-dialog">
			<h3>Account Found</h3>
			<p>
				An account with the email
				<strong>{{ loginForm.get("email")?.value }}</strong> already
				exists.
			</p>
			<p>
				Would you like to sign in as <strong>{{ foundUsername }}</strong
				>?
			</p>

			<div class="modal-actions">
				<button
					type="button"
					class="btn-secondary"
					(click)="cancelEmailConfirmation()"
				>
					No, use different email
				</button>
				<button
					type="button"
					class="btn-primary"
					(click)="confirmEmailUser()"
				>
					Yes, that's me
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Display data when available -->
<div *ngIf="dataAvailable(); else noData" class="data-display">
	<h3>Form Data:</h3>
	<p>Username = {{ loginForm.get("username")?.value || "" }}</p>
	<p>Password = {{ loginForm.get("password")?.value || "" }}</p>
	<p>Email Provider = {{ loginForm.get("email.provider")?.value || "" }}</p>
	<p>Email = {{ loginForm.get("email.emailString")?.value || "" }}</p>
</div>

<ng-template #noData>
	<h2 style="color: chartreuse">Complete the form to see data</h2>
</ng-template>
